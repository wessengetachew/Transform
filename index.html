
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Enhanced Modular Lifting Rings ‚Äî M√∂bius Shell Sieve</title>
<style>
:root{--bg:#0d1321;--bg2:#151b2d;--txt:#e0e6ed;--txt2:#a0aab8;--bord:#2a3a50;--acc:#00d9ff;--gold:#ffd700}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--txt);line-height:1.5;min-height:100vh}
body.light{--bg:#f5f5f5;--bg2:#fff;--txt:#1a1a2e;--txt2:#555;--bord:#ddd;--acc:#0066cc}
header{background:linear-gradient(135deg,#151b2d 0%,#1a2540 100%);padding:1rem;border-bottom:2px solid var(--gold);text-align:center}
header h1{font-size:1.5rem;background:linear-gradient(90deg,#ffd700,#00d9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
header p{font-size:.8rem;color:var(--txt2);margin-top:.25rem}
.container{max-width:1900px;margin:0 auto;padding:.75rem}
.ctrl{display:flex;flex-wrap:wrap;gap:.4rem;margin:.4rem 0}
.cg{display:flex;flex-direction:column;gap:.15rem;min-width:90px}
.cg label{font-size:.7rem;color:var(--txt2)}
.cg input,.cg select{padding:4px 6px;border:1px solid var(--bord);border-radius:3px;background:var(--bg);color:var(--txt);font-size:.8rem}
button{padding:5px 10px;border:1px solid var(--bord);border-radius:3px;background:var(--bg2);color:var(--txt);cursor:pointer;font-size:.75rem;transition:all .15s}
button:hover{background:var(--acc);color:#000}
canvas{border:1px solid var(--bord);border-radius:4px;background:#0a0e14;display:block}
.panel{background:var(--bg2);border:1px solid var(--bord);border-radius:6px;padding:.6rem;margin-bottom:.75rem}
.panel h4{color:var(--gold);margin-bottom:.4rem;font-size:.85rem;border-bottom:1px solid var(--bord);padding-bottom:.25rem}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.3rem;font-size:.75rem}
.stat-item{background:rgba(0,217,255,.08);padding:.3rem .4rem;border-radius:3px;border-left:2px solid var(--acc)}
.stat-item .label{font-size:.6rem;color:var(--txt2)}
.stat-item .value{font-size:.85rem;color:var(--gold);font-weight:bold}
.main-grid{display:grid;grid-template-columns:1fr 380px;gap:.75rem}
.canvas-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.canvas-wrap h5{color:var(--acc);font-size:.8rem;margin-bottom:.25rem}
.legend{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:.25rem;font-size:.65rem}
.legend span{padding:2px 5px;border-radius:2px;background:var(--bg);border:1px solid var(--bord)}
.theme-toggle{position:fixed;top:.5rem;right:.5rem;z-index:1000;padding:4px 8px;border-radius:15px;font-size:.7rem}
.selected-box{background:rgba(0,255,136,.1);border:1px solid #00ff88;border-radius:4px;padding:.4rem;margin-top:.4rem;font-size:.75rem}
.path-box{background:rgba(150,100,255,.1);border:1px solid #9664ff;border-radius:4px;padding:.4rem;margin-top:.4rem;font-size:.75rem}
@media(max-width:1400px){.main-grid{grid-template-columns:1fr}.canvas-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()">üåì</button>
<header>
<h1>Enhanced Modular Lifting Rings</h1>
<p>Interactive ring visualization ‚Ä¢ Stern-Brocot tree ‚Ä¢ Cayley transform ‚Ä¢ Sector analysis</p>
</header>
<div class="container">

<!-- Controls Panel -->
<div class="panel">
<div class="ctrl">
<div class="cg"><label><strong style="color:#00d9ff">Mode</strong></label>
<select id="enhMode" onchange="enhModeChange();drawAll()">
<option value="range">Range M‚ÇÅ-M‚ÇÇ</option>
<option value="power">Power a‚Åø</option>
<option value="custom">Custom</option>
</select></div>
<div id="enhRangeControls" class="ctrl">
<div class="cg"><label>Min</label><input type="number" id="enhMin" value="1" min="1" max="200" onchange="drawAll()"></div>
<div class="cg"><label>Max</label><input type="number" id="enhMax" value="30" min="1" max="200" onchange="drawAll()"></div>
</div>
<div id="enhPowerControls" style="display:none" class="ctrl">
<div class="cg"><label>Base</label><input type="number" id="enhBase" value="2" min="2" max="20" onchange="drawAll()"></div>
<div class="cg"><label>MaxExp</label><input type="number" id="enhMaxExp" value="10" min="1" max="15" onchange="drawAll()"></div>
</div>
<div id="enhCustomControls" style="display:none" class="ctrl">
<div class="cg" style="min-width:200px"><label>Custom</label><input type="text" id="enhCustomList" value="1,2,4,8,16,32" onchange="drawAll()"></div>
</div>

<div class="cg"><label>Color</label>
<select id="enhColor" onchange="drawAll()">
<option value="gcd">GCD</option>
<option value="angular">Angular</option>
<option value="ring">Ring</option>
<option value="sector">Sector</option>
</select></div>
<div class="cg"><label>PtScale</label><input type="range" id="enhPtScale" min="0.3" max="2.5" step="0.1" value="1" oninput="drawAll()"></div>
<div class="cg"><label>Rotation</label><input type="range" id="enhRot" min="0" max="360" value="0" oninput="drawAll()"></div>
<div class="cg"><label>RingInc¬∞</label><input type="number" id="enhRingInc" value="0" step="0.5" style="width:60px" onchange="drawAll()"></div>
</div>

<div class="ctrl" style="background:rgba(150,100,255,.1);border-radius:4px;padding:.4rem">
<div class="cg"><label style="display:flex;align-items:center;gap:.3rem">
<input type="checkbox" id="enhHighlightSector" onchange="drawAll()"> <strong style="color:#9664ff">Sector 1/a to 1/b</strong></label></div>
<div class="cg"><label>From 1/</label><input type="number" id="enhSectorFrom" value="3" min="2" max="50" onchange="drawAll()"></div>
<div class="cg"><label>To 1/</label><input type="number" id="enhSectorTo" value="2" min="1" max="50" onchange="drawAll()"></div>
<div class="cg"><label>Tree Depth</label><input type="number" id="enhTreeDepth" value="6" min="2" max="10" onchange="drawAll()"></div>
<div class="cg"><label>Cayley N</label><input type="number" id="caySectorN" value="12" min="3" max="30" onchange="drawAll()"></div>
</div>

<div class="ctrl">
<button onclick="enhSetRange(1,12)">M‚â§12</button>
<button onclick="enhSetRange(1,30)">M‚â§30</button>
<button onclick="enhSetPower(2,10)" style="background:#2a4a6a;color:#fff">2‚Åø</button>
<button onclick="enhSetPower(3,8)" style="background:#4a2a6a;color:#fff">3‚Åø</button>
<button onclick="enhSetPrimorials()" style="background:#1a472a;color:#fff">Primorials</button>
<button onclick="toggleAnim()" id="animBtn">‚ñ∂ Animate</button>
<button onclick="screenshotAll()">üì∑ Screenshot</button>
<button onclick="csvExport()">CSV</button>
</div>
</div>

<!-- Main Content Grid -->
<div class="main-grid">
<div>
<!-- Main Canvas -->
<div class="canvas-wrap">
<h5>Modular Ring Visualization <span id="mainCanvasInfo" style="color:var(--txt2);font-size:.7rem"></span></h5>
<canvas id="cenhanced" width="700" height="700"></canvas>
<div id="alenhanced" class="legend"></div>
</div>

<!-- Secondary Canvases Grid -->
<div class="canvas-grid" style="margin-top:.75rem">
<div class="canvas-wrap">
<h5 style="color:#00ff88">Stern-Brocot Tree <span id="treeInfo" style="color:var(--txt2);font-size:.65rem"></span></h5>
<canvas id="cSternBrocot" width="500" height="350"></canvas>
<div id="enhTreePath" class="path-box" style="display:none"></div>
</div>
<div class="canvas-wrap">
<h5 style="color:#9664ff">Cayley Transform (Sector) <span id="cayInfo" style="color:var(--txt2);font-size:.65rem"></span></h5>
<canvas id="cCayley" width="500" height="350"></canvas>
<div class="legend"><span style="color:#ffd700">‚óè Coprime</span><span style="color:#9664ff">‚óè In Sector</span><span style="color:#00ff88">‚óè Selected</span></div>
</div>
</div>
</div>

<!-- Right Sidebar -->
<div>
<div class="panel">
<h4> Statistics</h4>
<div id="enhStats" class="stats-grid"></div>
</div>

<div class="panel" id="sectorPanel" style="display:none">
<h4 style="color:#9664ff"> Sector Analysis</h4>
<div id="sectorStats"></div>
</div>

<div class="panel" id="selectedPanel" style="display:none">
<h4 style="color:#00ff88">Selected Point</h4>
<div id="selectedInfo"></div>
</div>

<div class="panel">
<h4> Guide</h4>
<div style="font-size:.7rem;color:var(--txt2)">
<p>‚Ä¢ <strong>Click</strong> points to select and see path in tree</p>
<p>‚Ä¢ <strong>Enable Sector</strong> to focus on 1/a to 1/b range</p>
<p>‚Ä¢ Tree shows mediant construction path</p>
<p>‚Ä¢ Cayley maps unit disk ‚Üî upper half-plane</p>
</div>
</div>
</div>
</div>

</div>

<script>
// Theme
function toggleTheme(){document.body.classList.toggle('light');drawAll();}
function isDark(){return !document.body.classList.contains('light');}

// Utilities
const gcd=(a,b)=>{a=Math.abs(Math.round(a));b=Math.abs(Math.round(b));while(b)[a,b]=[b,a%b];return a||1;};
function reduceFrac(a,b){const g=gcd(a,b);return{p:a/g,q:b/g,str:`${a/g}/${b/g}`};}

// State
let enhRingsData=[];
let selectedPoint=null;
let animating=false;
let animFrame=0;
let animId=null;
window.enhSBTreeNodes=[];
window.enhSBHighlightPath=[];
window.enhSBSelectedNode=null;
window.enhSBTreeBounds=null;

// Mode controls
function enhModeChange(){
  const mode=document.getElementById('enhMode').value;
  document.getElementById('enhRangeControls').style.display=mode==='range'?'flex':'none';
  document.getElementById('enhPowerControls').style.display=mode==='power'?'flex':'none';
  document.getElementById('enhCustomControls').style.display=mode==='custom'?'flex':'none';
}

// Presets
function enhSetRange(min,max){
  document.getElementById('enhMode').value='range';
  document.getElementById('enhMin').value=min;
  document.getElementById('enhMax').value=max;
  enhModeChange();drawAll();
}
function enhSetPower(base,exp){
  document.getElementById('enhMode').value='power';
  document.getElementById('enhBase').value=base;
  document.getElementById('enhMaxExp').value=exp;
  enhModeChange();drawAll();
}
function enhSetPrimorials(){
  document.getElementById('enhMode').value='custom';
  document.getElementById('enhCustomList').value='1,2,6,30,210,2310';
  enhModeChange();drawAll();
}

// Get moduli
function getModuli(){
  const mode=document.getElementById('enhMode').value;
  let moduli=[];
  if(mode==='range'){
    const min=+document.getElementById('enhMin').value||1;
    const max=+document.getElementById('enhMax').value||30;
    for(let m=min;m<=max;m++)moduli.push(m);
  }else if(mode==='power'){
    const base=+document.getElementById('enhBase').value||2;
    const maxExp=+document.getElementById('enhMaxExp').value||10;
    for(let e=0;e<=maxExp;e++)moduli.push(Math.pow(base,e));
  }else{
    moduli=document.getElementById('enhCustomList').value.split(',').map(s=>+s.trim()).filter(n=>n>0);
  }
  return moduli.filter(m=>m>=1);
}

// Animation
function toggleAnim(){
  animating=!animating;
  document.getElementById('animBtn').textContent=animating?'‚è∏ Pause':'‚ñ∂ Animate';
  if(animating)animate();
  else if(animId)cancelAnimationFrame(animId);
}
function animate(){
  if(!animating)return;
  animFrame=(animFrame+0.5)%360;
  drawAll();
  animId=requestAnimationFrame(animate);
}

// Draw all canvases
function drawAll(){
  drawMainCanvas();
  drawSternBrocotTree();
  drawCayleyCanvas();
  updateStats();
}

// Main modular rings canvas
function drawMainCanvas(){
  const c=document.getElementById('cenhanced');
  if(!c)return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  const cx=w/2,cy=h/2;
  const dk=isDark();
  
  ctx.fillStyle=dk?'#0a0e14':'#fff';
  ctx.fillRect(0,0,w,h);
  
  const moduli=getModuli();
  if(!moduli.length)return;
  
  // Build ring data
  enhRingsData=moduli.map(m=>{
    const allRes=[],coprimes=[];
    for(let r=0;r<m;r++){
      allRes.push(r);
      if(gcd(r,m)===1)coprimes.push(r);
    }
    return{mod:m,allRes,coprimes};
  });
  
  // Settings
  const colMode=document.getElementById('enhColor').value;
  const ptScale=+document.getElementById('enhPtScale').value||1;
  const rot=(+document.getElementById('enhRot').value+animFrame)*Math.PI/180;
  const ringInc=+document.getElementById('enhRingInc').value*Math.PI/180;
  const highlightSector=document.getElementById('enhHighlightSector').checked;
  const sectorFrom=+document.getElementById('enhSectorFrom').value||3;
  const sectorTo=+document.getElementById('enhSectorTo').value||2;
  
  const innerR=25,outerR=Math.min(cx,cy)-35;
  const numRings=enhRingsData.length;
  
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rot);
  
  // Unit circle
  ctx.beginPath();
  ctx.arc(0,0,outerR,0,2*Math.PI);
  ctx.strokeStyle=dk?'rgba(0,255,136,.25)':'rgba(0,170,85,.25)';
  ctx.lineWidth=1.5;
  ctx.stroke();
  
  // Sector highlight
  if(highlightSector){
    const fromAngle=2*Math.PI*(1-1/sectorFrom);
    const toAngle=2*Math.PI*(1-1/sectorTo);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,outerR+8,fromAngle,toAngle);
    ctx.closePath();
    ctx.fillStyle='rgba(150,100,255,.12)';
    ctx.fill();
    ctx.strokeStyle='rgba(150,100,255,.4)';
    ctx.lineWidth=1.5;
    ctx.stroke();
    
    // Update tree bounds
    window.enhSBTreeBounds={fromN:sectorFrom,toN:sectorTo};
  }
  
  // Draw rings
  let totalPts=0,totalCop=0,sectorPts=0,sectorCop=0;
  
  enhRingsData.forEach((ring,ringIdx)=>{
    const radius=numRings>1?innerR+(outerR-innerR)*ringIdx/(numRings-1):outerR*0.6;
    ring.radius=radius;
    const ringRotation=ringIdx*ringInc;
    
    ring.allRes.forEach(r=>{
      const gcd1=gcd(r,ring.mod)===1;
      const angle=2*Math.PI*(ring.mod-r)/ring.mod+ringRotation;
      const px=radius*Math.cos(angle);
      const py=radius*Math.sin(angle);
      
      const frac=r/ring.mod;
      const inSector=highlightSector&&frac>1/sectorFrom&&frac<1/sectorTo;
      
      let ptSz=(ring.mod===1?6:radius>200?4:3.5)*ptScale;
      if(inSector&&gcd1)ptSz*=1.25;
      
      // Color
      let clr;
      if(colMode==='gcd')clr=gcd1?(dk?'#ffd700':'#cc8800'):(dk?'#444':'#ccc');
      else if(colMode==='angular'){const hue=(r/ring.mod)*360;clr=`hsl(${hue},75%,55%)`;}
      else if(colMode==='ring'){const hue=(ringIdx/numRings)*280;clr=`hsl(${hue},65%,50%)`;}
      else if(colMode==='sector'){
        if(inSector&&gcd1)clr='#9664ff';
        else clr=gcd1?(dk?'#ffd700':'#cc8800'):(dk?'#333':'#ddd');
      }
      
      // Highlight selected
      const isSelected=selectedPoint&&selectedPoint.residue===r&&selectedPoint.mod===ring.mod;
      if(isSelected){clr='#00ff88';ptSz*=1.5;}
      
      ctx.beginPath();
      ctx.arc(px,py,ptSz,0,2*Math.PI);
      ctx.fillStyle=clr;
      ctx.fill();
      
      totalPts++;
      if(gcd1)totalCop++;
      if(inSector){sectorPts++;if(gcd1)sectorCop++;}
    });
  });
  
  ctx.restore();
  
  // Store stats
  window.enhTotalPts=totalPts;
  window.enhTotalCop=totalCop;
  window.enhSectorPts=sectorPts;
  window.enhSectorCop=sectorCop;
  
  // Info
  document.getElementById('mainCanvasInfo').textContent=`${moduli.length} rings, ${totalPts} pts`;
  
  // Legend
  const leg=document.getElementById('alenhanced');
  if(colMode==='gcd')leg.innerHTML='<span style="color:#ffd700">‚óè Coprime</span><span style="color:#555">‚óè Non-coprime</span>';
  else if(colMode==='sector')leg.innerHTML='<span style="color:#9664ff">‚óè In Sector</span><span style="color:#ffd700">‚óè Coprime</span>';
  else leg.innerHTML='<span>Color: '+colMode+'</span>';
}

// Stern-Brocot Tree
function drawSternBrocotTree(){
  const c=document.getElementById('cSternBrocot');
  if(!c)return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  const dk=isDark();
  
  ctx.fillStyle=dk?'#0a0e14':'#fff';
  ctx.fillRect(0,0,w,h);
  
  const highlightSector=document.getElementById('enhHighlightSector').checked;
  if(!highlightSector){
    ctx.fillStyle=dk?'#555':'#999';
    ctx.font='12px Segoe UI';
    ctx.textAlign='center';
    ctx.fillText('Enable Sector Highlight to view Stern-Brocot Tree',w/2,h/2);
    document.getElementById('treeInfo').textContent='';
    return;
  }
  
  const fromN=+document.getElementById('enhSectorFrom').value||3;
  const toN=+document.getElementById('enhSectorTo').value||2;
  const maxDepth=+document.getElementById('enhTreeDepth').value||6;
  
  // Boundaries
  const left={p:1,q:fromN};
  const right={p:1,q:toN};
  
  // Build tree
  const nodes=[];
  const maxQ=Math.max(...getModuli(),60);
  
  function buildTree(l,r,depth,x,y,width){
    if(depth>maxDepth)return;
    const medP=l.p+r.p;
    const medQ=l.q+r.q;
    if(medQ>maxQ)return;
    
    nodes.push({p:medP,q:medQ,x,y,depth,left:l,right:r});
    
    const childY=y+Math.min(45,h/(maxDepth+2));
    const childW=width/2;
    buildTree(l,{p:medP,q:medQ},depth+1,x-childW,childY,childW);
    buildTree({p:medP,q:medQ},r,depth+1,x+childW,childY,childW);
  }
  
  buildTree(left,right,0,w/2,35,w/4);
  window.enhSBTreeNodes=nodes;
  
  // Highlight path
  const highlightPath=window.enhSBHighlightPath||[];
  const isOnPath=node=>highlightPath.some(h=>h.p===node.p&&h.q===node.q);
  
  // Draw edges
  nodes.forEach(node=>{
    const children=nodes.filter(n=>n.depth===node.depth+1&&Math.abs(n.x-node.x)<w/Math.pow(2,node.depth+1.5));
    children.forEach(child=>{
      const onPath=isOnPath(node)&&isOnPath(child);
      ctx.strokeStyle=onPath?'rgba(0,255,136,.8)':'rgba(150,100,255,.3)';
      ctx.lineWidth=onPath?2.5:1;
      ctx.beginPath();
      ctx.moveTo(node.x,node.y+8);
      ctx.lineTo(child.x,child.y-8);
      ctx.stroke();
    });
  });
  
  // Draw nodes
  nodes.forEach(node=>{
    const isSelected=window.enhSBSelectedNode&&window.enhSBSelectedNode.p===node.p&&window.enhSBSelectedNode.q===node.q;
    const onPath=isOnPath(node);
    const r=node.depth===0?10:isSelected?9:8-node.depth*0.5;
    
    ctx.beginPath();
    ctx.arc(node.x,node.y,Math.max(4,r),0,2*Math.PI);
    ctx.fillStyle=isSelected?'#00ff88':onPath?'#00d9ff':node.depth===0?'#ffd700':`hsl(${node.depth*45},65%,50%)`;
    ctx.fill();
    
    if(isSelected||onPath){
      ctx.strokeStyle=isSelected?'#00ff88':'#00d9ff';
      ctx.lineWidth=2;
      ctx.stroke();
    }
    
    // Label
    if(r>5){
      ctx.fillStyle='#fff';
      ctx.font=`${node.depth===0?'bold ':''}${Math.max(7,9-node.depth)}px Segoe UI`;
      ctx.textAlign='center';
      ctx.fillText(`${node.p}/${node.q}`,node.x,node.y+3);
    }
  });
  
  // Boundaries
  ctx.fillStyle='#9664ff';
  ctx.font='9px Segoe UI';
  ctx.textAlign='left';
  ctx.fillText(`1/${fromN}`,5,15);
  ctx.textAlign='right';
  ctx.fillText(`1/${toN}`,w-5,15);
  
  document.getElementById('treeInfo').textContent=`depth ${maxDepth}, ${nodes.length} nodes`;
}

// Find path in Stern-Brocot tree
function findSBPath(p,q){
  const path=[];
  let left={p:0,q:1},right={p:1,q:1};
  for(let i=0;i<50;i++){
    const mp=left.p+right.p;
    const mq=left.q+right.q;
    path.push({p:mp,q:mq});
    if(mp===p&&mq===q)return path;
    if(p*mq<mp*q)right={p:mp,q:mq};
    else left={p:mp,q:mq};
  }
  return path;
}

// Highlight in tree
function highlightInSBTree(p,q){
  const pathEl=document.getElementById('enhTreePath');
  if(!window.enhSBTreeBounds){
    pathEl.style.display='block';
    pathEl.innerHTML='<span style="color:#888">Enable sector first</span>';
    return;
  }
  
  const{fromN,toN}=window.enhSBTreeBounds;
  const frac=p/q;
  
  if(frac<=1/fromN||frac>=1/toN){
    pathEl.style.display='block';
    pathEl.innerHTML=`<span style="color:#ff8c00">${p}/${q} outside sector</span>`;
    window.enhSBHighlightPath=[];
    window.enhSBSelectedNode=null;
    drawSternBrocotTree();
    return;
  }
  
  window.enhSBHighlightPath=findSBPath(p,q);
  window.enhSBSelectedNode={p,q};
  
  pathEl.style.display='block';
  const pathStr=window.enhSBHighlightPath.map(n=>`${n.p}/${n.q}`).join(' ‚Üí ');
  pathEl.innerHTML=`<strong style="color:#00ff88">Path to ${p}/${q}:</strong><br>${pathStr}`;
  
  drawSternBrocotTree();
}

// Cayley Transform Canvas
function drawCayleyCanvas(){
  const c=document.getElementById('cCayley');
  if(!c)return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  const dk=isDark();
  
  ctx.fillStyle=dk?'#0a0e14':'#fff';
  ctx.fillRect(0,0,w,h);
  
  const highlightSector=document.getElementById('enhHighlightSector').checked;
  if(!highlightSector){
    ctx.fillStyle=dk?'#555':'#999';
    ctx.font='12px Segoe UI';
    ctx.textAlign='center';
    ctx.fillText('Enable Sector Highlight to view Cayley Transform',w/2,h/2);
    document.getElementById('cayInfo').textContent='';
    return;
  }
  
  const sectorFrom=+document.getElementById('enhSectorFrom').value||3;
  const sectorTo=+document.getElementById('enhSectorTo').value||2;
  const N=+document.getElementById('caySectorN').value||12;
  
  // Dual view: disk left, half-plane right
  const diskCx=w*0.25,diskCy=h/2,diskR=Math.min(w*0.22,h*0.42);
  const hpOx=w*0.75,hpOy=h-25;
  const hpRange=2.5;
  const hpScX=(w*0.4)/(2*hpRange),hpScY=(h-50)/hpRange;
  
  // Generate Farey points in sector
  const points=[];
  for(let q=1;q<=N;q++){
    for(let p=0;p<=q;p++){
      if(gcd(p,q)===1){
        const frac=p/q;
        if(frac>1/sectorFrom&&frac<1/sectorTo){
          points.push({p,q,frac});
        }
      }
    }
  }
  
  // Cayley transform: w = i(1+z)/(1-z)
  function cayley(z){
    const numRe=1+z.re,numIm=z.im;
    const denRe=1-z.re,denIm=-z.im;
    const denMag=denRe*denRe+denIm*denIm;
    if(denMag<1e-10)return{re:0,im:100};
    const quotRe=(numRe*denRe+numIm*denIm)/denMag;
    const quotIm=(numIm*denRe-numRe*denIm)/denMag;
    return{re:-quotIm,im:quotRe};
  }
  
  // Draw disk
  ctx.strokeStyle=dk?'rgba(0,217,255,.3)':'rgba(0,102,204,.3)';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.arc(diskCx,diskCy,diskR,0,2*Math.PI);
  ctx.stroke();
  
  // Draw half-plane axes
  ctx.strokeStyle=dk?'rgba(255,255,255,.2)':'rgba(0,0,0,.15)';
  ctx.beginPath();
  ctx.moveTo(hpOx-hpScX*hpRange,hpOy);
  ctx.lineTo(hpOx+hpScX*hpRange,hpOy);
  ctx.stroke();
  
  // Sector arc on disk
  const fromAngle=2*Math.PI*(1-1/sectorFrom);
  const toAngle=2*Math.PI*(1-1/sectorTo);
  ctx.beginPath();
  ctx.arc(diskCx,diskCy,diskR,fromAngle,toAngle);
  ctx.strokeStyle='rgba(150,100,255,.5)';
  ctx.lineWidth=3;
  ctx.stroke();
  
  // Draw points
  points.forEach(pt=>{
    const angle=2*Math.PI*pt.frac;
    const zx=Math.cos(angle),zy=Math.sin(angle);
    const wPt=cayley({re:zx,im:zy});
    
    const isSelected=selectedPoint&&selectedPoint.residue===pt.p&&selectedPoint.mod===pt.q;
    const clr=isSelected?'#00ff88':'#9664ff';
    const sz=isSelected?6:4;
    
    // On disk
    ctx.beginPath();
    ctx.arc(diskCx+zx*diskR*0.95,diskCy-zy*diskR*0.95,sz,0,2*Math.PI);
    ctx.fillStyle=clr;
    ctx.fill();
    
    // On half-plane
    if(wPt.im>0&&wPt.im<hpRange&&Math.abs(wPt.re)<hpRange){
      ctx.beginPath();
      ctx.arc(hpOx+wPt.re*hpScX,hpOy-wPt.im*hpScY,sz,0,2*Math.PI);
      ctx.fillStyle=clr;
      ctx.fill();
    }
  });
  
  // Labels
  ctx.fillStyle=dk?'#00d9ff':'#0066cc';
  ctx.font='10px Segoe UI';
  ctx.textAlign='center';
  ctx.fillText('Unit Disk ùîª',diskCx,h-8);
  ctx.fillText('Upper Half-Plane ‚Ñç',hpOx,h-8);
  
  document.getElementById('cayInfo').textContent=`N=${N}, ${points.length} pts in sector`;
}

// Update stats
function updateStats(){
  const stats=document.getElementById('enhStats');
  const moduli=getModuli();
  const totPhi=enhRingsData.reduce((s,r)=>s+r.coprimes.length,0);
  
  stats.innerHTML=`
    <div class="stat-item"><div class="label">Rings</div><div class="value">${moduli.length}</div></div>
    <div class="stat-item"><div class="label">Total Pts</div><div class="value">${(window.enhTotalPts||0).toLocaleString()}</div></div>
    <div class="stat-item"><div class="label">Coprimes</div><div class="value">${(window.enhTotalCop||0).toLocaleString()}</div></div>
    <div class="stat-item"><div class="label">Density</div><div class="value">${window.enhTotalPts?((window.enhTotalCop/window.enhTotalPts)*100).toFixed(1)+'%':'0%'}</div></div>
    <div class="stat-item"><div class="label">Œ£œÜ(m)</div><div class="value">${totPhi.toLocaleString()}</div></div>
    <div class="stat-item"><div class="label">Max M</div><div class="value">${Math.max(...moduli)}</div></div>
  `;
  
  // Sector panel
  const sectorPanel=document.getElementById('sectorPanel');
  const sectorStats=document.getElementById('sectorStats');
  if(document.getElementById('enhHighlightSector').checked){
    const from=document.getElementById('enhSectorFrom').value;
    const to=document.getElementById('enhSectorTo').value;
    sectorPanel.style.display='block';
    sectorStats.innerHTML=`
      <div style="margin-bottom:.3rem"><strong>Sector:</strong> 1/${from} to 1/${to}</div>
      <div>Points: <strong style="color:#9664ff">${window.enhSectorPts||0}</strong></div>
      <div>Coprimes: <strong style="color:#00ff88">${window.enhSectorCop||0}</strong></div>
      <div>Density: <strong>${window.enhSectorPts?((window.enhSectorCop/window.enhSectorPts)*100).toFixed(1)+'%':'0%'}</strong></div>
    `;
  }else{
    sectorPanel.style.display='none';
  }
}

// Click handlers
document.getElementById('cenhanced')?.addEventListener('click',function(e){
  const c=this;
  const rect=c.getBoundingClientRect();
  const clickX=(e.clientX-rect.left)*(c.width/rect.width);
  const clickY=(e.clientY-rect.top)*(c.height/rect.height);
  const cx=c.width/2,cy=c.height/2;
  let x=clickX-cx,y=clickY-cy;
  
  const rot=(+document.getElementById('enhRot').value+animFrame)*Math.PI/180;
  const cosR=Math.cos(-rot),sinR=Math.sin(-rot);
  const ux=x*cosR-y*sinR,uy=x*sinR+y*cosR;
  
  let closest=null,minDist=Infinity;
  const numRings=enhRingsData.length;
  const outerR=Math.min(cx,cy)-35,innerR=25;
  const ringInc=+document.getElementById('enhRingInc').value*Math.PI/180;
  
  enhRingsData.forEach((ring,ringIdx)=>{
    const radius=numRings>1?innerR+(outerR-innerR)*ringIdx/(numRings-1):outerR*0.6;
    const ringRotation=ringIdx*ringInc;
    
    ring.allRes.forEach(r=>{
      const angle=2*Math.PI*(ring.mod-r)/ring.mod+ringRotation;
      const px=radius*Math.cos(angle),py=radius*Math.sin(angle);
      const dist=Math.sqrt((ux-px)**2+(uy-py)**2);
      if(dist<minDist&&dist<20){
        minDist=dist;
        closest={residue:r,mod:ring.mod,gcd:gcd(r,ring.mod),isCoprime:gcd(r,ring.mod)===1};
      }
    });
  });
  
  if(closest){
    selectedPoint=closest;
    showSelectedPoint(closest);
    if(closest.isCoprime){
      const red=reduceFrac(closest.residue,closest.mod);
      highlightInSBTree(red.p,red.q);
    }
    drawAll();
  }
});

document.getElementById('cSternBrocot')?.addEventListener('click',function(e){
  const c=this;
  const rect=c.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(c.width/rect.width);
  const my=(e.clientY-rect.top)*(c.height/rect.height);
  
  let closest=null,minDist=15;
  (window.enhSBTreeNodes||[]).forEach(node=>{
    const dist=Math.sqrt((node.x-mx)**2+(node.y-my)**2);
    if(dist<minDist){minDist=dist;closest=node;}
  });
  
  if(closest){
    highlightInSBTree(closest.p,closest.q);
    // Also update main selection
    selectedPoint={residue:closest.p,mod:closest.q,gcd:1,isCoprime:true};
    showSelectedPoint(selectedPoint);
    drawMainCanvas();
    drawCayleyCanvas();
  }
});

function showSelectedPoint(pt){
  const panel=document.getElementById('selectedPanel');
  const info=document.getElementById('selectedInfo');
  panel.style.display='block';
  const red=reduceFrac(pt.residue,pt.mod);
  info.innerHTML=`
    <div><strong>${pt.residue}/${pt.mod}</strong> = ${red.str}</div>
    <div>Value: ${(pt.residue/pt.mod).toFixed(6)}</div>
    <div>GCD: ${pt.gcd}</div>
    <div>Coprime: ${pt.isCoprime?'<span style="color:#00ff88">Yes</span>':'<span style="color:#ff6060">No</span>'}</div>
  `;
}

// Screenshot
function screenshotAll(){
  const c=document.getElementById('cenhanced');
  if(!c)return;
  const dk=isDark();
  const scale=2;
  const pad=30,titleH=50,footerH=30;
  const totalW=(c.width+pad*2)*scale;
  const totalH=(c.height+titleH+footerH+pad)*scale;
  
  const out=document.createElement('canvas');
  out.width=totalW;out.height=totalH;
  const ctx=out.getContext('2d');
  
  ctx.fillStyle=dk?'#0d1321':'#fff';
  ctx.fillRect(0,0,totalW,totalH);
  
  ctx.fillStyle=dk?'#00d9ff':'#0066cc';
  ctx.font='bold 24px Segoe UI';
  ctx.textAlign='center';
  ctx.fillText('Enhanced Modular Lifting Rings',totalW/2,35);
  
  ctx.drawImage(c,pad*scale,(titleH+10)*scale,c.width*scale,c.height*scale);
  
  // Path info
  if(window.enhSBHighlightPath?.length>0&&window.enhSBSelectedNode){
    ctx.fillStyle=dk?'rgba(13,19,33,.92)':'rgba(255,255,255,.92)';
    const pathX=(pad+15)*scale,pathY=(titleH+25)*scale;
    const pathW=180*scale,pathH=Math.min(180,40+window.enhSBHighlightPath.length*16)*scale;
    ctx.fillRect(pathX,pathY,pathW,pathH);
    ctx.strokeStyle='rgba(0,255,136,.6)';
    ctx.lineWidth=2;
    ctx.strokeRect(pathX,pathY,pathW,pathH);
    ctx.fillStyle='#00ff88';
    ctx.font='bold 14px Segoe UI';
    ctx.textAlign='left';
    ctx.fillText('STERN-BROCOT PATH',pathX+12,pathY+22);
    ctx.fillStyle='#ffd700';
    ctx.fillText(`‚Üí ${window.enhSBSelectedNode.p}/${window.enhSBSelectedNode.q}`,pathX+12,pathY+42);
    ctx.fillStyle='#00d9ff';
    ctx.font='12px Segoe UI';
    let py=pathY+62;
    window.enhSBHighlightPath.slice(0,8).forEach((n,i)=>{
      ctx.fillText(`${i===window.enhSBHighlightPath.length-1?'‚óè':'‚Üí'} ${n.p}/${n.q}`,pathX+12,py);
      py+=18;
    });
  }
  
  // Legend
  const legX=(pad+c.width-160)*scale,legY=(titleH+25)*scale;
  ctx.fillStyle=dk?'rgba(13,19,33,.92)':'rgba(255,255,255,.92)';
  ctx.fillRect(legX,legY,150*scale,90*scale);
  ctx.strokeStyle=dk?'rgba(0,217,255,.5)':'rgba(0,102,204,.5)';
  ctx.strokeRect(legX,legY,150*scale,90*scale);
  ctx.fillStyle=dk?'#00d9ff':'#0066cc';
  ctx.font='bold 14px Segoe UI';
  ctx.fillText('LEGEND',legX+12,legY+20);
  ctx.font='12px Segoe UI';
  ctx.fillStyle='#ffd700';ctx.fillText('‚óè Coprime',legX+12,legY+40);
  ctx.fillStyle='#555';ctx.fillText('‚óè Non-coprime',legX+12,legY+58);
  ctx.fillStyle='#9664ff';ctx.fillText('‚ñ∞ Sector',legX+12,legY+76);
  
  ctx.fillStyle=dk?'#506080':'#888';
  ctx.font='12px Segoe UI';
  ctx.textAlign='center';
  ctx.fillText('Enhanced Modular Rings ‚Äî @7dview',totalW/2,totalH-12);
  
  out.toBlob(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download='enhanced_modular.png';
    a.click();
  },'image/png');
}

// CSV
function csvExport(){
  let csv='Modulus,Residue,GCD,Coprime,Fraction,Decimal\n';
  enhRingsData.forEach(ring=>{
    ring.allRes.forEach(r=>{
      const g=gcd(r,ring.mod);
      csv+=`${ring.mod},${r},${g},${g===1?'Yes':'No'},${r}/${ring.mod},${(r/ring.mod).toFixed(6)}\n`;
    });
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='enhanced_modular.csv';
  a.click();
}

// Init
document.addEventListener('DOMContentLoaded',()=>{
  enhModeChange();
  drawAll();
});
</script>
</body>
</html>
